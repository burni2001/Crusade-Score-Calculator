<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Adeptus Astartes - Mission Debrief</title>
        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#050a05" />
        <!-- Matches background_color from manifest -->
        <style>
            @import url("https://fonts.googleapis.com/css2?family=VT323&display=swap");

            :root {
                --pip-green: #33ff00;
                --pip-dim: #1a8000;
                --bg-color: #050a05;
                --panel-bg: #0c140c;
                --border-color: #1f3a1f;
            }
            body {
                background-color: #000;
                color: var(--pip-green);
                font-family: "VT323", monospace;
                margin: 0;
                padding: 20px;
                display: flex;
                justify-content: center;
                min-height: 100vh;
                background-image: repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                );
            }
            /* CRT Screen Effect */
            .cogitator-frame {
                width: 100%;
                max-width: 1100px;
                background-color: var(--bg-color);
                border: 4px solid #3d4c3d;
                box-shadow:
                    0 0 20px rgba(51, 255, 0, 0.2),
                    inset 0 0 50px rgba(0, 0, 0, 0.8);
                padding: 20px;
                position: relative;
            }
            .cogitator-frame::before {
                content: " ";
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                background:
                    linear-gradient(
                        rgba(18, 16, 16, 0) 50%,
                        rgba(0, 0, 0, 0.25) 50%
                    ),
                    linear-gradient(
                        90deg,
                        rgba(255, 0, 0, 0.06),
                        rgba(0, 255, 0, 0.02),
                        rgba(0, 0, 255, 0.06)
                    );
                z-index: 2;
                background-size:
                    100% 2px,
                    3px 100%;
                pointer-events: none;
            }
            h1,
            h2,
            h3 {
                text-transform: uppercase;
                text-align: center;
                margin: 5px 0;
                text-shadow: 0 0 5px var(--pip-green);
                letter-spacing: 2px;
            }

            .header-decor {
                border-bottom: 2px solid var(--pip-green);
                margin-bottom: 20px;
                padding-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
            }
            /* Inputs and Selects Styling */
            input,
            select {
                background-color: #000;
                color: var(--pip-green);
                border: 1px solid var(--pip-green);
                font-family: "VT323", monospace;
                font-size: 1.2rem;
                text-align: center;
                padding: 2px;
                width: 100%;
                box-sizing: border-box;
            }
            input:focus,
            select:focus {
                outline: none;
                box-shadow: 0 0 8px var(--pip-green);
                background-color: #0f240f;
            }

            /* Layout Sections */
            .section {
                background-color: rgba(20, 40, 20, 0.3);
                border: 1px solid var(--border-color);
                padding: 15px;
                margin-bottom: 20px;
            }

            /* Modifier Grid */
            .modifier-grid {
                display: grid;
                grid-template-columns: 100px repeat(7, 1fr);
                gap: 10px;
                align-items: center;
                text-align: center;
                font-size: 1.1rem;
            }

            .modifier-grid label {
                font-size: 0.9rem;
                opacity: 0.8;
            }
            /* Global Toggles (Dropdowns) styling inside .section */
            /* To make labels and selects align */
            .mission-params {
                display: grid;
                /* Fixed width for label column for alignment.
               minmax ensures input has at least 140px, then takes 1fr. */
                grid-template-columns: 160px minmax(140px, 1fr);
                gap: 10px;
                margin-bottom: 10px;
                align-items: center; /* Vertically align label and select */
                font-size: 1.1rem;
            }
            /* Ensure labels wrap if they are longer than the fixed column width */
            .mission-params label {
                word-wrap: break-word; /* For older browsers */
                overflow-wrap: break-word; /* Standard property for breaking words */
            }

            /* NEW: Container for Dropdowns and Description (side-by-side) */
            .mission-info-area {
                display: grid;
                grid-template-columns: 1fr 2fr; /* Dropdowns (smaller) and Description (larger) */
                gap: 20px; /* Space between the two columns */
                margin-bottom: 20px;
            }

            /* NEW: Styling for the description text area */
            .app-description {
                background-color: rgba(20, 40, 20, 0.3);
                border: 1px solid var(--border-color);
                padding: 15px;
                line-height: 1.5; /* Readability */
                font-size: 1.1rem;
                text-align: left;
                overflow-y: auto; /* In case text is too long */
            }

            /* Main Score Table */
            .score-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 5px;
            }

            .score-table th {
                text-align: center;
                padding: 10px;
                background-color: #000;
                border: 1px solid var(--pip-dim);
            }
            /* Specific style for empty header to remove it visually */
            .score-table th.empty-header {
                background-color: transparent;
                border: none;
                box-shadow: none;
            }

            .score-table td {
                padding: 4px;
                vertical-align: middle;
                border: 1px solid var(--border-color); /* Add border to cells */
                background-color: var(--panel-bg); /* Add background to cells */
            }

            .row-label {
                text-align: right;
                padding-right: 15px !important;
                font-weight: bold;
                width: 180px; /* Fixed width for labels */
                background-color: #000; /* Darker background for labels */
            }
            .input-cell {
                width: 120px; /* Fixed width for input cells */
            }

            .total-cell {
                width: 120px; /* Fixed width for total cells */
                text-align: center;
                font-weight: bold;
                background-color: #000; /* Darker background for totals */
            }
            .section-header {
                background-color: #000;
                color: var(--pip-green);
                padding: 5px;
                font-weight: bold;
                text-align: center;
                margin-bottom: 15px;
                border: 1px solid var(--pip-green);
            }
            /* Specific Rows styling based on screenshot logic */
            .base-score-row td,
            .mod-score-row td {
                font-weight: bold;
                text-align: center;
                padding-top: 15px;
                padding-bottom: 15px;
            }
            .final-score-row td {
                border-top: 2px solid var(--pip-green);
                border-bottom: 2px double var(--pip-green);
                font-size: 1.5rem;
                font-weight: bold;
                color: #afffa6; /* Brighter green */
                text-align: center;
                padding: 15px 0;
                text-shadow: 0 0 8px var(--pip-green);
            }
            /* Chrome styling for number inputs (hide spinners) */
            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
            }

            /* Styling for selected options in dropdowns */
            select option {
                background-color: #000; /* Dark background for dropdown options */
                color: #0f0; /* Green text for options */
            }
            /* Style for disabled/hidden placeholder option */
            select option[disabled][selected][hidden] {
                color: rgba(0, 255, 0, 0.5); /* Lighter green for placeholder */
            }
            /* Export Buttons Container */
            .export-buttons-container {
                display: flex;
                flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
                justify-content: center;
                gap: 20px;
                margin-top: 25px;
                padding-top: 15px;
                border-top: 1px solid var(--border-color);
            }

            .export-buttons-container button {
                background-color: var(--panel-bg);
                color: var(--pip-green);
                border: 1px solid var(--pip-green);
                padding: 10px 20px;
                font-family: "VT323", monospace;
                font-size: 1.1rem;
                cursor: pointer;
                text-transform: uppercase;
                letter-spacing: 1px;
                transition: all 0.2s ease-in-out;
                box-shadow: 0 0 5px rgba(51, 255, 0, 0.2);
                flex: 1 1 auto; /* Allow buttons to grow/shrink, maintain aspect */
                min-width: 180px; /* Minimum width before wrapping */
            }

            .export-buttons-container button:hover {
                background-color: var(--pip-green);
                color: var(--bg-color);
                box-shadow: 0 0 15px var(--pip-green);
            }

            .export-buttons-container button.danger-btn {
                border-color: #ff6600;
                color: #ff6600;
            }

            .export-buttons-container button.danger-btn:hover {
                background-color: #ff6600;
                color: var(--bg-color);
                box-shadow: 0 0 15px #ff6600;
            }

            /* OCR Review Modal */
            .ocr-modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.9);
                z-index: 1000;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }

            .ocr-modal-overlay.active {
                display: flex;
            }

            .ocr-modal {
                background-color: var(--bg-color);
                border: 2px solid var(--pip-green);
                box-shadow: 0 0 30px rgba(51, 255, 0, 0.3);
                max-width: 800px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                padding: 20px;
            }

            .ocr-modal h2 {
                margin-top: 0;
                border-bottom: 1px solid var(--pip-green);
                padding-bottom: 10px;
            }

            .ocr-modal-section {
                margin-bottom: 20px;
            }

            .ocr-modal-section h3 {
                font-size: 1.1rem;
                margin-bottom: 10px;
                color: var(--pip-dim);
            }

            .ocr-raw-text {
                background-color: #000;
                border: 1px solid var(--border-color);
                padding: 10px;
                max-height: 150px;
                overflow-y: auto;
                font-size: 0.9rem;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .ocr-detected-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .ocr-detected-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: rgba(51, 255, 0, 0.1);
                padding: 8px 12px;
                border: 1px solid var(--border-color);
            }

            .ocr-detected-item.not-found {
                background-color: rgba(255, 100, 0, 0.1);
                border-color: #ff6600;
            }

            .ocr-detected-label {
                font-weight: bold;
            }

            .ocr-detected-value {
                color: #afffa6;
            }

            .ocr-detected-value.missing {
                color: #ff6600;
                font-style: italic;
            }

            .ocr-modal-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid var(--border-color);
            }

            .ocr-modal-buttons button {
                background-color: var(--panel-bg);
                color: var(--pip-green);
                border: 1px solid var(--pip-green);
                padding: 10px 25px;
                font-family: "VT323", monospace;
                font-size: 1.1rem;
                cursor: pointer;
                text-transform: uppercase;
            }

            .ocr-modal-buttons button:hover {
                background-color: var(--pip-green);
                color: var(--bg-color);
            }

            .ocr-modal-buttons button.cancel-btn {
                border-color: #ff6600;
                color: #ff6600;
            }

            .ocr-modal-buttons button.cancel-btn:hover {
                background-color: #ff6600;
                color: var(--bg-color);
            }

            @media (max-width: 768px) {
                .ocr-detected-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* --- Responsive Design Adjustments --- */
            @media (max-width: 768px) {
                body {
                    padding: 10px; /* Reduce overall padding */
                }
                .cogitator-frame {
                    padding: 10px; /* Reduce frame padding */
                    border-width: 2px; /* Thinner border */
                    box-shadow:
                        0 0 10px rgba(51, 255, 0, 0.2),
                        inset 0 0 25px rgba(0, 0, 0, 0.8);
                }

                .header-decor {
                    flex-direction: column; /* Stack items vertically */
                    align-items: center; /* Center items */
                    text-align: center;
                    margin-bottom: 10px;
                }
                .header-decor > div {
                    margin-bottom: 5px; /* Add some space between stacked header elements */
                }

                h1 {
                    font-size: 1.5em; /* Smaller mission debrief title */
                }

                input,
                select {
                    font-size: 1rem; /* Smaller font size for inputs/selects */
                    padding: 1px;
                }

                .section {
                    padding: 10px; /* Reduce section padding */
                    margin-bottom: 15px; /* Adjust margin */
                }
                /* Modifiers Grid */
                .modifier-grid {
                    /* Auto-fit items into available space, minimum 100px. Can result in 2 or 3 columns depending on screen. */
                    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                    gap: 5px; /* Reduce gap */
                }
                /* Make the 'MODIFIERS' label span all columns and center it */
                .modifier-grid div:first-child {
                    grid-column: 1 / -1;
                    text-align: center !important;
                    margin-bottom: 5px;
                }

                /* Mission Info Area (Dropdowns + Description) */
                .mission-info-area {
                    grid-template-columns: 1fr; /* Stack dropdowns and description vertically */
                    gap: 15px; /* Space between stacked sections */
                }
                .mission-info-area .section {
                    margin-bottom: 0; /* No extra margin for the inner section */
                }

                /* Mission Params (individual dropdowns) */
                .mission-params {
                    grid-template-columns: 1fr; /* Stack label and select vertically */
                    gap: 2px; /* Reduce gap */
                    margin-bottom: 8px; /* Reduce margin */
                    font-size: 1rem;
                }
                .mission-params label {
                    text-align: left; /* Align labels left when stacked */
                    margin-bottom: 2px;
                    /* On small screens (stacked), labels will naturally take full width, so word-wrap isn't strictly needed here but doesn't hurt */
                }

                /* App Description */
                .app-description {
                    font-size: 1rem;
                }

                /* Score Table - Make scrollable on small screens */
                .score-table-container {
                    overflow-x: auto;
                }

                /* Export buttons */
                .export-buttons-container {
                    flex-direction: column;
                    gap: 10px;
                }
                .export-buttons-container button {
                    width: 100%;
                    font-size: 1rem;
                    padding: 8px 15px;
                }
            }
            /* Further adjustments for very small screens (e.g., typical smartphone portrait) */
            @media (max-width: 480px) {
                .modifier-grid {
                    grid-template-columns: 1fr; /* Stack all modifiers vertically */
                }
                .modifier-grid div:first-child {
                    /* The 'MODIFIERS' label */
                    grid-column: auto; /* Reset grid-column to normal flow */
                }
            }
        </style>
    </head>
    <body>
        <div class="cogitator-frame">
            <div class="header-decor">
                <div>
                    <div>REF: SM-2/CRUSADE</div>
                    <div style="font-size: 0.8em; opacity: 0.7">
                        V 0.5.33 - ADEPTUS ADMINISTRATUM
                    </div>
                </div>
                <h1>Mission Debrief</h1>
                <div>DAT: M42.024</div>
            </div>
            <!-- Modifiers Section -->
            <div class="section">
                <div class="modifier-grid">
                    <div style="text-align: left; font-weight: bold">
                        MODIFIERS
                    </div>

                    <div>
                        <label>Kills</label>
                        <input
                            type="number"
                            id="mod-kills"
                            value="1"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Elite Kills</label>
                        <input
                            type="number"
                            id="mod-elite"
                            value="20"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Death</label>
                        <input
                            type="number"
                            id="mod-death"
                            value="-100"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Damage</label>
                        <input
                            type="number"
                            id="mod-damage"
                            value="-0.1"
                            step="0.1"
                            inputmode="decimal"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Geneseed</label>
                        <input
                            type="number"
                            id="mod-gene"
                            value="100"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Armoury</label>
                        <input
                            type="number"
                            id="mod-armoury"
                            value="25"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                    <div>
                        <label>Objective</label>
                        <input
                            type="number"
                            id="mod-obj"
                            value="100"
                            inputmode="numeric"
                            onchange="calculate(); saveData();"
                        />
                    </div>
                </div>
            </div>
            <!-- NEW: Mission Info Area: Dropdowns (left) and Description (right) -->
            <div class="mission-info-area">
                <!-- Global Toggles Section (your dropdowns) -->
                <div class="section" style="margin-bottom: 0">
                    <!-- Remove bottom margin as parent handles spacing -->
                    <!-- Screenshot Upload Section -->
                    <div
                        style="
                            margin-bottom: 15px;
                            padding: 10px;
                            background-color: rgba(51, 255, 0, 0.1);
                            border: 1px solid var(--pip-green);
                        "
                    >
                        <label
                            for="screenshot-upload"
                            style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: bold;
                                text-align: center;
                            "
                        >
                            UPLOAD SCREENSHOTS
                        </label>
                        <input
                            type="file"
                            id="screenshot-upload"
                            accept="image/png,image/jpeg,image/jpg"
                            multiple
                            style="
                                display: block;
                                margin: 0 auto;
                                padding: 8px;
                                background-color: var(--panel-bg);
                                cursor: pointer;
                            "
                        />
                        <div
                            id="upload-status"
                            style="
                                margin-top: 10px;
                                text-align: center;
                                font-size: 0.9rem;
                                min-height: 20px;
                            "
                        ></div>
                        <div
                            id="upload-progress"
                            style="
                                margin-top: 5px;
                                text-align: center;
                                font-size: 0.85rem;
                                color: var(--pip-dim);
                            "
                        ></div>
                    </div>
                    <!-- NEW: Mission Played input field -->
                    <div class="mission-params">
                        <label for="mission-name">Mission Played</label>
                        <input
                            type="text"
                            id="mission-name"
                            value=""
                            placeholder="e.g., Inferno"
                            onchange="saveData();"
                        />
                    </div>
                    <div class="mission-params">
                        <label for="mission-difficulty">Difficulty</label>
                        <select
                            id="mission-difficulty"
                            onchange="calculate(); saveData();"
                        >
                            <option value="" disabled selected hidden>
                                Select Difficulty
                            </option>
                            <option value="Minimal">Minimal</option>
                            <option value="Average">Average</option>
                            <option value="Substantial">Substantial</option>
                            <option value="Ruthless">Ruthless</option>
                            <option value="Lethal">Lethal</option>
                            <option value="Absolute">Absolute</option>
                            <option value="Normal">Normal</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="mission-params">
                        <label>Objective Completion</label>
                        <select
                            id="global-objective"
                            onchange="calculate(); saveData();"
                        >
                            <option value="" disabled selected hidden>
                                Select
                            </option>
                            <option value="0">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </div>
                    <div class="mission-params">
                        <label>Geneseed Retrieved</label>
                        <select
                            id="global-geneseed"
                            onchange="calculate(); saveData();"
                        >
                            <option value="" disabled selected hidden>
                                Select
                            </option>
                            <option value="0">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </div>
                    <div class="mission-params">
                        <label>Armoury Data Retrieved</label>
                        <select
                            id="global-armoury"
                            onchange="calculate(); saveData();"
                        >
                            <option value="" disabled selected hidden>
                                Select
                            </option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
                <!-- THIS IS WHERE YOU WRITE YOUR DESCRIPTION TEXT! -->
                <div class="app-description">
                    Welcome, Brothers and Sisters! Use this debriefingp tool to
                    calculate your mission scores. Select the Mission
                    parameters. Enter your mission statistics (Kills, Deaths,
                    etc.) below. The Modifier section allows customization of
                    score values if necessary. Ensure all fields are filled for
                    an accurate debrief.
                    <br /><br />
                    *Glory to the Imperium!*
                </div>
            </div>
            <!-- Main Data Table (Squad Performance Matrix) -->
            <div class="section" style="margin-bottom: 0">
                <!-- Last section, no bottom margin -->
                <div class="section-header">SQUAD PERFORMANCE MATRIX</div>
                <div class="score-table-container">
                    <!-- ADD THIS WRAPPER -->
                    <table class="score-table">
                        <thead>
                            <tr>
                                <th class="empty-header"></th>
                                <th>
                                    <input
                                        type="text"
                                        value=""
                                        placeholder="Name"
                                        class="player-name-input"
                                        id="p1-name"
                                        onchange="saveData();"
                                    />
                                </th>
                                <th>
                                    <input
                                        type="text"
                                        value=""
                                        placeholder="Name"
                                        class="player-name-input"
                                        id="p2-name"
                                        onchange="saveData();"
                                    />
                                </th>
                                <th>
                                    <input
                                        type="text"
                                        value=""
                                        placeholder="Name"
                                        class="player-name-input"
                                        id="p3-name"
                                        onchange="saveData();"
                                    />
                                </th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Kills -->
                            <tr>
                                <td class="row-label">Kills</td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p1-input"
                                        id="p1-kills"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p2-input"
                                        id="p2-kills"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p3-input"
                                        id="p3-kills"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="total-cell" id="total-kills">0</td>
                            </tr>
                            <!-- Elite Kills -->
                            <tr>
                                <td class="row-label">Elite Kills</td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p1-input"
                                        id="p1-elite"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p2-input"
                                        id="p2-elite"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p3-input"
                                        id="p3-elite"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="total-cell" id="total-elite">0</td>
                            </tr>
                            <!-- Base Score Result -->
                            <tr class="base-score-row">
                                <td class="row-label">Base Score</td>
                                <td id="p1-base">0</td>
                                <td id="p2-base">0</td>
                                <td id="p3-base">0</td>
                                <td id="total-base">0</td>
                            </tr>
                            <!-- Death -->
                            <tr>
                                <td class="row-label">Death</td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p1-input"
                                        id="p1-death"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p2-input"
                                        id="p2-death"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p3-input"
                                        id="p3-death"
                                        value="0"
                                        min="0"
                                        inputmode="numeric"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="total-cell" id="total-death">0</td>
                            </tr>
                            <!-- Damage -->
                            <tr>
                                <td class="row-label">Damage</td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p1-input"
                                        id="p1-damage"
                                        value="0"
                                        min="0"
                                        step="0.1"
                                        inputmode="decimal"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p2-input"
                                        id="p2-damage"
                                        value="0"
                                        min="0"
                                        step="0.1"
                                        inputmode="decimal"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="input-cell">
                                    <input
                                        type="number"
                                        class="p3-input"
                                        id="p3-damage"
                                        value="0"
                                        min="0"
                                        step="0.1"
                                        inputmode="decimal"
                                        onchange="calculate(); saveData();"
                                    />
                                </td>
                                <td class="total-cell" id="total-damage">0</td>
                            </tr>

                            <!-- Modifier Score Result -->
                            <tr class="mod-score-row">
                                <td class="row-label">Modifier Score</td>
                                <td id="p1-mod">0</td>
                                <td id="p2-mod">0</td>
                                <td id="p3-mod">0</td>
                                <td id="total-mod">0</td>
                            </tr>
                            <!-- Spacer -->
                            <tr style="height: 10px"></tr>
                            <!-- TOTAL SCORE -->
                            <tr class="final-score-row">
                                <td class="row-label" style="color: #afffa6">
                                    TOTAL SCORE
                                </td>
                                <td id="p1-final">0</td>
                                <td id="p2-final">0</td>
                                <td id="p3-final">0</td>
                                <td id="total-final">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- END OF WRAPPER -->
            </div>
            <!-- Export Buttons -->
            <div class="export-buttons-container">
                <button onclick="exportToCSV()">
                    Export to Data Slate (CSV)
                </button>
                <button onclick="saveAsPNG()">
                    Record Cogitator Display (PNG)
                </button>
                <button class="danger-btn" onclick="clearData()">
                    Clear Mission Data
                </button>
            </div>
        </div>

        <!-- OCR Review Modal -->
        <div id="ocr-modal-overlay" class="ocr-modal-overlay">
            <div class="ocr-modal">
                <h2>OCR Results Review</h2>
                
                <div class="ocr-modal-section">
                    <h3>Detected Values</h3>
                    <div id="ocr-detected-grid" class="ocr-detected-grid">
                    </div>
                </div>

                <div class="ocr-modal-section">
                    <h3>Raw OCR Text (for manual review)</h3>
                    <div id="ocr-raw-text" class="ocr-raw-text"></div>
                </div>

                <div class="ocr-modal-buttons">
                    <button onclick="applyOCRResults()">Apply Values</button>
                    <button class="cancel-btn" onclick="closeOCRModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- html2canvas library for PNG export -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <!-- Tesseract.js for OCR -->
        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
        <script>
            // Store OCR results for review
            let pendingOCRResults = {};
            let rawOCRText = "";

            // Screenshot Upload and OCR Processing
            document
                .getElementById("screenshot-upload")
                .addEventListener("change", async function (e) {
                    const files = e.target.files;
                    if (files.length === 0) return;

                    const statusDiv = document.getElementById("upload-status");
                    const progressDiv =
                        document.getElementById("upload-progress");

                    statusDiv.textContent = "Processing screenshots...";
                    statusDiv.style.color = "var(--pip-green)";

                    // Reset pending results
                    pendingOCRResults = {};
                    rawOCRText = "";

                    try {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            progressDiv.textContent = `Processing image ${i + 1} of ${files.length}...`;

                            await processScreenshot(
                                file,
                                statusDiv,
                                progressDiv,
                            );
                        }

                        statusDiv.textContent =
                            "OCR complete - review results below";
                        statusDiv.style.color = "#afffa6";
                        progressDiv.textContent = "";

                        // Show the review modal
                        showOCRModal();

                        // Clear the file input for future uploads
                        e.target.value = "";
                    } catch (error) {
                        console.error("OCR Error:", error);
                        statusDiv.textContent =
                            "Error processing screenshots. Please try again.";
                        statusDiv.style.color = "#ff3300";
                        progressDiv.textContent = "";
                    }
                });

            async function processScreenshot(file, statusDiv, progressDiv) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = async function (e) {
                        try {
                            const imageData = e.target.result;

                            // Use Tesseract.js to extract text
                            const {
                                data: { text },
                            } = await Tesseract.recognize(imageData, "eng", {
                                logger: (m) => {
                                    if (m.status === "recognizing text") {
                                        progressDiv.textContent = `OCR Progress: ${Math.round(m.progress * 100)}%`;
                                    }
                                },
                            });

                            // Store raw text
                            rawOCRText += text + "\n\n---\n\n";

                            // Parse the extracted text and store results
                            parseGameData(text);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            function parseGameData(text) {
                // Preprocess: normalize text by removing star symbols, XP badges, and extra whitespace
                let cleanText = text
                    .replace(/[★☆✦✧⭐]/g, ' ')  // Remove star symbols
                    .replace(/xp\s*\d+/gi, ' ')   // Remove "XP 10" type badges
                    .replace(/\s+/g, ' ');        // Collapse whitespace
                
                const lowerText = text.toLowerCase();

                // Extract mission name from "MISSION: X" format
                const missionMatch = text.match(/mission\s*[:\-]\s*([A-Za-z][A-Za-z\s\-']+)/i);
                if (missionMatch) {
                    let missionName = missionMatch[1].trim();
                    // Stop at STATUS if captured
                    missionName = missionName.replace(/\s*status.*$/i, '').trim();
                    if (missionName.length > 2 && missionName.length < 40) {
                        pendingOCRResults["mission-name"] = missionName;
                    }
                }

                // Extract difficulty (exact word match)
                const difficulties = ["minimal", "average", "substantial", "ruthless", "lethal", "absolute"];
                difficulties.forEach((diff) => {
                    const diffRegex = new RegExp('\\b' + diff + '\\b', 'i');
                    if (diffRegex.test(text)) {
                        pendingOCRResults["mission-difficulty"] = diff.charAt(0).toUpperCase() + diff.slice(1);
                    }
                });

                // Check for STATUS: SUCCESS
                if (/status\s*[:\-]\s*success/i.test(text)) {
                    pendingOCRResults["global-objective"] = "1";
                }
                if (/\bvictory\b/i.test(text)) {
                    pendingOCRResults["global-objective"] = "1";
                }

                // Check for Gene-Seed Found
                if (/gene[-\s]?seed\s+(found|retrieved|collected)/i.test(text)) {
                    pendingOCRResults["global-geneseed"] = "1";
                }

                // Extract player name: Look for name on line before class name
                // Pattern: Name appears on a line, followed by CLASS on next line
                const classNames = ['BULWARK', 'ASSAULT', 'VANGUARD', 'TACTICAL', 'SNIPER', 'HEAVY'];
                const lines = text.split(/\n/);
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    // Check if this line is a class name
                    const upperLine = line.toUpperCase();
                    if (classNames.some(c => upperLine === c || upperLine.startsWith(c + ' '))) {
                        // Previous line should be the player name
                        if (i > 0) {
                            let playerName = lines[i - 1].trim();
                            // Clean up the name - remove any non-letter chars at start/end
                            playerName = playerName.replace(/^[^A-Za-zÄÖÜäöüéèêëâáàæøåãñ]+/, '');
                            playerName = playerName.replace(/[^A-Za-zÄÖÜäöüéèêëâáàæøåãñ\s]+$/, '');
                            
                            if (playerName.length > 1 && playerName.length < 30) {
                                // Find next available player slot
                                for (let p = 1; p <= 3; p++) {
                                    if (!pendingOCRResults[`p${p}-name`]) {
                                        pendingOCRResults[`p${p}-name`] = playerName;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Helper: Extract 3 consecutive numbers from a line after a label
                function extractThreeNumbers(labelPattern, searchText) {
                    // Find the label and then extract the 3 numbers after it
                    const regex = new RegExp(labelPattern + '[^\\d]*(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)', 'i');
                    const match = searchText.match(regex);
                    if (match) {
                        const nums = [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
                        if (nums.every(n => !isNaN(n) && n >= 0 && n < 1000000)) {
                            return nums;
                        }
                    }
                    return null;
                }

                // Parse stat rows - use cleaned text for number extraction
                // Kills (but not "Special Kills")
                const killsNums = extractThreeNumbers('(?<!special\\s)\\bkills\\b', cleanText);
                if (killsNums) {
                    pendingOCRResults["p1-kills"] = killsNums[0];
                    pendingOCRResults["p2-kills"] = killsNums[1];
                    pendingOCRResults["p3-kills"] = killsNums[2];
                }

                // Special Kills -> Elite Kills
                const specialNums = extractThreeNumbers('special\\s*kills', cleanText);
                if (specialNums) {
                    pendingOCRResults["p1-elite"] = specialNums[0];
                    pendingOCRResults["p2-elite"] = specialNums[1];
                    pendingOCRResults["p3-elite"] = specialNums[2];
                }

                // Incapacitations -> Death
                const incapNums = extractThreeNumbers('incapacitations?', cleanText);
                if (incapNums) {
                    pendingOCRResults["p1-death"] = incapNums[0];
                    pendingOCRResults["p2-death"] = incapNums[1];
                    pendingOCRResults["p3-death"] = incapNums[2];
                }

                // Damage Taken -> Damage
                const damageNums = extractThreeNumbers('damage\\s*taken', cleanText);
                if (damageNums) {
                    pendingOCRResults["p1-damage"] = damageNums[0];
                    pendingOCRResults["p2-damage"] = damageNums[1];
                    pendingOCRResults["p3-damage"] = damageNums[2];
                }

                // Armoury data - look for small digit (0-3) after "armoury" or in rewards section
                const armouryMatch = text.match(/armoury\s*(?:data)?\s*[=:\-\s]*(\d)/i);
                if (armouryMatch) {
                    const num = parseInt(armouryMatch[1]);
                    if (num >= 0 && num <= 3) {
                        pendingOCRResults["global-armoury"] = armouryMatch[1];
                    }
                } else if (/rewards/i.test(text)) {
                    // Look in the rewards section for a small number
                    const rewardsMatch = text.match(/rewards[\s\S]{0,50}?\b([0-3])\b/i);
                    if (rewardsMatch) {
                        pendingOCRResults["global-armoury"] = rewardsMatch[1];
                    }
                }
            }

            // Show OCR review modal
            function showOCRModal() {
                const modal = document.getElementById("ocr-modal-overlay");
                const grid = document.getElementById("ocr-detected-grid");
                const rawTextDiv = document.getElementById("ocr-raw-text");

                // Display raw text
                rawTextDiv.textContent = rawOCRText || "No text detected";

                // Build detected values grid - organized by category
                const fieldLabels = {
                    "mission-name": "Mission",
                    "mission-difficulty": "Difficulty",
                    "global-objective": "Objective Complete",
                    "global-geneseed": "Geneseed Retrieved",
                    "global-armoury": "Armoury Data",
                    "p1-name": "Player 1 Name",
                    "p1-kills": "P1 Kills",
                    "p1-elite": "P1 Elite Kills",
                    "p1-death": "P1 Deaths",
                    "p1-damage": "P1 Damage",
                    "p2-name": "Player 2 Name",
                    "p2-kills": "P2 Kills",
                    "p2-elite": "P2 Elite Kills",
                    "p2-death": "P2 Deaths",
                    "p2-damage": "P2 Damage",
                    "p3-name": "Player 3 Name",
                    "p3-kills": "P3 Kills",
                    "p3-elite": "P3 Elite Kills",
                    "p3-death": "P3 Deaths",
                    "p3-damage": "P3 Damage",
                };

                let gridHTML = "";
                for (const [key, label] of Object.entries(fieldLabels)) {
                    const value = pendingOCRResults[key];
                    const hasValue = value !== undefined && value !== "";
                    let displayValue = hasValue ? value : "Not detected";
                    
                    // Format special values
                    if (key === "global-objective" && value === "1") displayValue = "Yes";
                    if (key === "global-geneseed" && value === "1") displayValue = "Yes";

                    gridHTML += `
                        <div class="ocr-detected-item ${hasValue ? "" : "not-found"}">
                            <span class="ocr-detected-label">${label}:</span>
                            <span class="ocr-detected-value ${hasValue ? "" : "missing"}">${displayValue}</span>
                        </div>
                    `;
                }
                grid.innerHTML = gridHTML;

                // Show modal
                modal.classList.add("active");
            }

            // Apply OCR results to form
            function applyOCRResults() {
                for (const [fieldId, value] of Object.entries(pendingOCRResults)) {
                    const el = document.getElementById(fieldId);
                    if (el && value !== undefined && value !== "") {
                        el.value = value;
                    }
                }

                // Recalculate and save
                calculate();
                saveData();

                // Close modal
                closeOCRModal();

                // Update status
                const statusDiv = document.getElementById("upload-status");
                statusDiv.textContent = "Values applied successfully!";
                statusDiv.style.color = "#afffa6";
            }

            // Close OCR modal
            function closeOCRModal() {
                const modal = document.getElementById("ocr-modal-overlay");
                modal.classList.remove("active");
            }

            // Clear all data except modifiers
            function clearData() {
                if (!confirm("Clear all mission data? (Modifiers will be kept)")) {
                    return;
                }

                // List of fields to clear (everything except modifiers)
                const fieldsToClear = [
                    "mission-name",
                    "mission-difficulty",
                    "global-objective",
                    "global-geneseed",
                    "global-armoury",
                    "p1-name",
                    "p2-name",
                    "p3-name",
                    "p1-kills",
                    "p2-kills",
                    "p3-kills",
                    "p1-elite",
                    "p2-elite",
                    "p3-elite",
                    "p1-death",
                    "p2-death",
                    "p3-death",
                    "p1-damage",
                    "p2-damage",
                    "p3-damage",
                ];

                fieldsToClear.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.tagName === "SELECT") {
                            el.selectedIndex = 0; // Reset to placeholder
                        } else {
                            el.value = el.type === "number" ? "0" : "";
                        }
                    }
                });

                // Recalculate and save
                calculate();
                saveData();
            }
        </script>
        <script>
            const STORAGE_KEY = "missionDebriefData";

            // List of all input/select IDs to save
            const inputIds = [
                "mod-kills",
                "mod-elite",
                "mod-death",
                "mod-damage",
                "mod-gene",
                "mod-armoury",
                "mod-obj",
                "mission-name",
                "mission-difficulty",
                "global-objective",
                "global-geneseed",
                "global-armoury",
                "p1-name",
                "p2-name",
                "p3-name",
                "p1-kills",
                "p2-kills",
                "p3-kills",
                "p1-elite",
                "p2-elite",
                "p3-elite",
                "p1-death",
                "p2-death",
                "p3-death",
                "p1-damage",
                "p2-damage",
                "p3-damage",
            ];

            // Save all form data to localStorage
            function saveData() {
                const data = {};
                inputIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        data[id] = el.value;
                    }
                });
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.warn("Could not save to localStorage:", e);
                }
            }

            // Load all form data from localStorage
            function loadData() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);
                        inputIds.forEach((id) => {
                            const el = document.getElementById(id);
                            if (
                                el &&
                                data[id] !== undefined &&
                                data[id] !== ""
                            ) {
                                el.value = data[id];
                            }
                        });
                    }
                } catch (e) {
                    console.warn("Could not load from localStorage:", e);
                }
            }

            // Helper to get float value from input ID, defaults to 0
            function getVal(id) {
                const el = document.getElementById(id);
                if (!el) return 0;
                const val = parseFloat(el.value);
                return isNaN(val) ? 0 : val;
            }
            // Helper to get string value from input ID, defaults to empty
            function getStr(id) {
                const el = document.getElementById(id);
                return el ? el.value.trim() : "";
            }

            // Helper to set text content of element
            function setTxt(id, txt) {
                const el = document.getElementById(id);
                if (el) el.textContent = txt;
            }

            function calculate() {
                // 1. Get Modifiers
                const modKills = getVal("mod-kills");
                const modElite = getVal("mod-elite");
                const modDeath = getVal("mod-death");
                const modDamage = getVal("mod-damage");
                const modGene = getVal("mod-gene");
                const modArmoury = getVal("mod-armoury");
                const modObj = getVal("mod-obj");

                // 2. Get Global statuses (handling empty string from placeholder)
                const globalObj =
                    document.getElementById("global-objective").value === ""
                        ? 0
                        : getVal("global-objective");
                const globalGene =
                    document.getElementById("global-geneseed").value === ""
                        ? 0
                        : getVal("global-geneseed");
                const globalArmoury =
                    document.getElementById("global-armoury").value === ""
                        ? 0
                        : getVal("global-armoury");

                // Initialize Total Accumulators for individual stats (for the TOTAL column)
                let sumKills = 0;
                let sumElite = 0;
                let sumDeath = 0;
                let sumDamage = 0;

                // --- Calculate for each player and accumulate individual sums for the total column ---
                for (let i = 1; i <= 3; i++) {
                    // Player Inputs
                    const kills = getVal(`p${i}-kills`);
                    const elite = getVal(`p${i}-elite`);
                    const death = getVal(`p${i}-death`);
                    const damage = getVal(`p${i}-damage`);

                    // Accumulate individual stats for the TOTAL column
                    sumKills += kills;
                    sumElite += elite;
                    sumDeath += death;
                    sumDamage += damage;

                    // Calculate Player's Base Score (individual kills + global objective)
                    const playerBaseScore =
                        kills * modKills +
                        elite * modElite +
                        globalObj * modObj;

                    // Calculate Player's Modifier Score (individual death/damage + global geneseed/armoury)
                    const playerModifierScore =
                        death * modDeath +
                        damage * modDamage +
                        globalGene * modGene +
                        globalArmoury * modArmoury;

                    // Calculate Player's Final Score
                    const playerFinalScore = Math.round(
                        playerBaseScore + playerModifierScore,
                    );

                    // Update DOM for Player
                    setTxt(`p${i}-base`, Math.round(playerBaseScore * 10) / 10);
                    setTxt(
                        `p${i}-mod`,
                        parseFloat(playerModifierScore.toFixed(1)),
                    );
                    setTxt(`p${i}-final`, playerFinalScore);
                }

                // --- Calculate and Update Total Column (ensuring global objectives are counted ONCE for the total) ---

                // Update total individual stats
                setTxt("total-kills", sumKills);
                setTxt("total-elite", sumElite);
                setTxt("total-death", sumDeath);
                setTxt("total-damage", sumDamage);

                // Calculate TOTAL Base Score for the squad
                // This is the sum of all individual kill-based scores PLUS the global objective score ONCE
                const totalSquadBaseScore =
                    sumKills * modKills +
                    sumElite * modElite +
                    globalObj * modObj;

                // Calculate TOTAL Modifier Score for the squad
                // This is the sum of all individual death/damage-based scores PLUS the global geneseed/armoury scores ONCE
                const totalSquadModifierScore =
                    sumDeath * modDeath +
                    sumDamage * modDamage +
                    globalGene * modGene +
                    globalArmoury * modArmoury;

                // Calculate TOTAL Final Score for the squad
                const totalSquadFinalScore = Math.round(
                    totalSquadBaseScore + totalSquadModifierScore,
                );

                // Update DOM for Total Column
                setTxt("total-base", Math.round(totalSquadBaseScore * 10) / 10);
                setTxt(
                    "total-mod",
                    parseFloat(totalSquadModifierScore.toFixed(1)),
                );
                setTxt("total-final", totalSquadFinalScore);
            }

            // Function to export table data to CSV
            function exportToCSV() {
                const missionName = getStr("mission-name");
                const missionDifficulty =
                    document.getElementById("mission-difficulty").value; // Get value here

                let filename = "Mission_Debrief_Data";
                if (missionName) {
                    filename = `${missionName.replace(/[^a-zA-Z0-9]/g, "_")}_Debrief_Data`;
                }
                filename += ".csv";

                const table = document.querySelector(".score-table");
                const rows = table.querySelectorAll("tr");
                const csv = [];

                // Add Mission Name and Global Parameters
                csv.push(`Mission Played:,${getStr("mission-name")}`);
                csv.push(`Difficulty:,${missionDifficulty}`); // NEW LINE HERE
                csv.push(
                    `Objective Completion:,${document.getElementById("global-objective").value === "1" ? "Yes" : "No"}`,
                );
                csv.push(
                    `Geneseed Retrieved:,${document.getElementById("global-geneseed").value === "1" ? "Yes" : "No"}`,
                );
                csv.push(`Armoury Data Retrieved:,${getVal("global-armoury")}`);
                csv.push(""); // Empty line for separation

                // Add Modifiers
                csv.push("MODIFIERS,,,,,"); // Header for modifiers row
                csv.push(`Kills:,${getVal("mod-kills")}`);
                csv.push(`Elite Kills:,${getVal("mod-elite")}`);
                csv.push(`Death:,${getVal("mod-death")}`);
                csv.push(`Damage:,${getVal("mod-damage")}`);
                csv.push(`Geneseed:,${getVal("mod-gene")}`);
                csv.push(`Armoury:,${getVal("mod-armoury")}`);
                csv.push(`Objective:,${getVal("mod-obj")}`);
                csv.push(""); // Empty line for separation

                // Iterate over table rows
                rows.forEach((row, rowIndex) => {
                    const rowData = [];
                    const cells = row.querySelectorAll("th, td");

                    cells.forEach((cell, cellIndex) => {
                        let cellValue = "";
                        // For input fields in headers (player names)
                        if (
                            rowIndex === 0 &&
                            cell.querySelector('input[type="text"]')
                        ) {
                            cellValue =
                                cell.querySelector('input[type="text"]')
                                    .value ||
                                cell.querySelector('input[type="text"]')
                                    .placeholder;
                        }
                        // For input fields in data cells
                        else if (cell.querySelector('input[type="number"]')) {
                            cellValue = cell.querySelector(
                                'input[type="number"]',
                            ).value;
                        }
                        // For text content
                        else {
                            cellValue = cell.textContent.trim();
                        }
                        rowData.push(`"${cellValue.replace(/"/g, '""')}"`); // Quote and escape double quotes
                    });
                    csv.push(rowData.join(","));
                });

                const csvFile = new Blob([csv.join("\n")], {
                    type: "text/csv;charset=utf-8;",
                });
                const downloadLink = document.createElement("a");
                downloadLink.download = filename;
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }

            // Function to save the entire cogitator-frame as PNG (always renders in wide desktop view)
            function saveAsPNG() {
                const element = document.querySelector(".cogitator-frame");
                const body = document.body;
                const html = document.documentElement;

                // Store original styles
                const originalElementWidth = element.style.width;
                const originalElementMaxWidth = element.style.maxWidth;
                const originalElementMinWidth = element.style.minWidth;
                const originalBodyOverflow = body.style.overflow;
                const originalBodyWidth = body.style.width;
                const originalHtmlWidth = html.style.width;
                const originalViewport = document.querySelector(
                    'meta[name="viewport"]',
                );
                const originalViewportContent = originalViewport
                    ? originalViewport.getAttribute("content")
                    : null;

                // Temporarily change viewport to allow wider rendering on mobile
                if (originalViewport) {
                    originalViewport.setAttribute(
                        "content",
                        "width=1200, initial-scale=1.0",
                    );
                }

                // Force wide desktop layout for screenshot - set on all containers
                element.style.width = "1100px";
                element.style.maxWidth = "1100px";
                element.style.minWidth = "1100px";
                body.style.width = "1200px";
                body.style.minWidth = "1200px";
                body.style.overflow = "visible";
                html.style.width = "1200px";
                html.style.minWidth = "1200px";

                // Wait for layout to settle, then capture
                setTimeout(() => {
                    html2canvas(element, {
                        scale: 2,
                        backgroundColor: "#000",
                        useCORS: true,
                        windowWidth: 1200,
                        windowHeight: 1400,
                        scrollX: 0,
                        scrollY: 0,
                        logging: true,
                        allowTaint: false,
                        foreignObjectRendering: false,
                    })
                        .then((canvas) => {
                            // Restore original styles
                            element.style.width = originalElementWidth;
                            element.style.maxWidth = originalElementMaxWidth;
                            element.style.minWidth = originalElementMinWidth;
                            body.style.overflow = originalBodyOverflow;
                            body.style.width = originalBodyWidth;
                            html.style.width = originalHtmlWidth;

                            // Restore viewport
                            if (originalViewport && originalViewportContent) {
                                originalViewport.setAttribute(
                                    "content",
                                    originalViewportContent,
                                );
                            }

                            console.log(
                                "Canvas dimensions:",
                                canvas.width,
                                "x",
                                canvas.height,
                            );

                            const link = document.createElement("a");
                            link.download = "Mission_Debrief_Display.png";
                            link.href = canvas.toDataURL("image/png");
                            link.click();
                        })
                        .catch((err) => {
                            // Restore styles on error too
                            element.style.width = originalElementWidth;
                            element.style.maxWidth = originalElementMaxWidth;
                            element.style.minWidth = originalElementMinWidth;
                            body.style.overflow = originalBodyOverflow;
                            body.style.width = originalBodyWidth;
                            html.style.width = originalHtmlWidth;

                            // Restore viewport
                            if (originalViewport && originalViewportContent) {
                                originalViewport.setAttribute(
                                    "content",
                                    originalViewportContent,
                                );
                            }

                            console.error("PNG export failed:", err);
                            alert(
                                "Failed to capture screenshot. Please try again.",
                            );
                        });
                }, 300); // Give more time for viewport change to take effect
            }

            // Initialize: load saved data and calculate when DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                loadData();
                calculate();
            });
        </script>

        <!-- Service Worker Registration -->
        <script>
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/service-worker.js")
                        .then((registration) => {
                            console.log(
                                "Service Worker registered! Scope:",
                                registration.scope,
                            );
                        })
                        .catch((err) => {
                            console.log(
                                "Service Worker registration failed:",
                                err,
                            );
                        });
                });
            }
        </script>
    </body>
</html>
